<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Farm Run - Игра</title>
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background: #f0f0f0; font-family: sans-serif; }
        canvas { display: block; background: #fff; border-bottom: 4px solid #333; margin: 0 auto; }
        
        #hud { position: absolute; top: 10px; left: 20px; z-index: 10; pointer-events: none; }
        .hud-text { font-size: 20px; font-weight: bold; color: #333; margin-bottom: 5px; }

        .ui-layer { 
            position: absolute; inset: 0; 
            background: rgba(255,255,255,0.9); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            z-index: 100; 
        }
        .hidden { display: none !important; }

        .menu-btn { 
            margin: 10px; padding: 15px 40px; 
            font-size: 18px; font-weight: bold; 
            cursor: pointer; background: #4CAF50; 
            color: white; border: none; border-radius: 8px; 
            min-width: 200px; transition: 0.2s;
        }
        .menu-btn:hover { background: #45a049; transform: scale(1.05); }
        .menu-btn.blue { background: #2196F3; }
        .menu-btn.orange { background: #FF9800; }
        
        #ad-video-overlay { background: #000; z-index: 1000; }
        #video-wrapper { width: 80%; max-width: 800px; aspect-ratio: 16/9; background: #111; }
    </style>
</head>
<body>

    <div id="hud">
        <div class="hud-text" id="score-info">Дистанция: 0 м</div>
        <div class="hud-text" id="total-coins-display" style="color: #B8860B;">Монеты: 0</div>
    </div>

    <button onclick="togglePause()" style="position:absolute; top:10px; right:20px; z-index:20; padding: 10px; cursor:pointer;">ПАУЗА (Esc)</button>

    <canvas id="gameCanvas"></canvas>

    <div id="pause-ui" class="ui-layer hidden">
        <h1>ПАУЗА</h1>
        <button class="menu-btn" onclick="togglePause()">ПРОДОЛЖИТЬ</button>
        <button class="menu-btn blue" onclick="openSettings()">НАСТРОЙКИ</button>
        <button class="menu-btn orange" onclick="location.href='index.html'">В МЕНЮ</button>
    </div>

    <div id="settings-ui" class="ui-layer hidden">
        <h1>НАСТРОЙКИ</h1>
        <label style="font-size:20px; margin-bottom:20px;">
            <input type="checkbox" id="sound-check" style="transform:scale(1.5);"> Звуки включены
        </label>
        <button class="menu-btn" onclick="closeSettings()">СОХРАНИТЬ</button>
    </div>

    <div id="game-ui" class="ui-layer hidden">
        <h1>ИГРА ОКОНЧЕНА</h1>
        <div id="res-stats" style="font-size: 20px; margin-bottom: 20px; text-align:center;"></div>
        <button class="menu-btn" onclick="resetGame()">ИГРАТЬ СНОВА</button>
        <button class="menu-btn orange" onclick="location.href='index.html'">В МЕНЮ</button>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 800; canvas.height = 250;

        // Загрузка настроек и ресурсов
        let soundEnabled = localStorage.getItem('dinoSound') !== 'false';
        const activeSkin = localStorage.getItem('activeSkin') || 'baran';

        // ПРОВЕРКА ПУТЕЙ: Убедись, что файлы лежат в этих папках!
        const sndJump = new Audio('sounds/jump.mp3');
        const sndHit = new Audio('sounds/hit.mp3');
        const imgPlayer = new Image(); imgPlayer.src = `images/${activeSkin}.png`;
        const imgCactus = new Image(); imgCactus.src = `images/cactus.png`;

        let imagesLoaded = 0;
        imgPlayer.onload = imgCactus.onload = () => { imagesLoaded++; };

        let isPlaying = true, isPaused = false;
        let distance = 0, sessionMoney = 0;
        let coinsBeforeRun = parseInt(localStorage.getItem('dinoCoins')) || 0;
        let gameSpeed = 5;
        let cacti = [];
        let dino = { x: 50, y: 200, dy: 0, jump: -13, grav: 0.7, ground: true };

        function playSnd(audio) {
            if(soundEnabled) { audio.currentTime = 0; audio.play().catch(e => console.log("Sound error")); }
        }

        function togglePause() {
            if (!isPlaying) return;
            isPaused = !isPaused;
            document.getElementById('pause-ui').classList.toggle('hidden', !isPaused);
            if (!isPaused) requestAnimationFrame(loop);
        }

        function openSettings() {
            document.getElementById('pause-ui').classList.add('hidden');
            document.getElementById('settings-ui').classList.remove('hidden');
            document.getElementById('sound-check').checked = soundEnabled;
        }

        function closeSettings() {
            soundEnabled = document.getElementById('sound-check').checked;
            localStorage.setItem('dinoSound', soundEnabled);
            document.getElementById('settings-ui').classList.add('hidden');
            document.getElementById('pause-ui').classList.remove('hidden');
        }

        function showEndScreen() {
            isPlaying = false;
            playSnd(sndHit);
            const total = coinsBeforeRun + sessionMoney;
            localStorage.setItem('dinoCoins', total);
            document.getElementById('res-stats').innerHTML = `Дистанция: ${Math.floor(distance)}м<br>Собрано монет: ${sessionMoney}`;
            document.getElementById('game-ui').classList.remove('hidden');
        }

        function resetGame() {
            location.reload();
        }

        function loop() {
            if (!isPlaying || isPaused) return;
            if (imagesLoaded < 2) { requestAnimationFrame(loop); return; } // Ждем загрузки картинок

            ctx.clearRect(0,0, canvas.width, canvas.height);
            gameSpeed += 0.001;
            distance += gameSpeed / 100;

            // Динозавр
            dino.dy += dino.grav;
            dino.y += dino.dy;
            if (dino.y > 200) { dino.y = 200; dino.dy = 0; dino.ground = true; }
            ctx.drawImage(imgPlayer, dino.x, dino.y, 50, 50);

            // Препятствия
            if (Math.random() < 0.01 && (cacti.length === 0 || cacti[cacti.length-1].x < 500)) {
                cacti.push({x: 800, y: 200});
            }

            for (let i = cacti.length-1; i>=0; i--) {
                cacti[i].x -= gameSpeed;
                ctx.drawImage(imgCactus, cacti[i].x, cacti[i].y, 40, 50);

                // Коллизия
                if (dino.x < cacti[i].x + 30 && dino.x + 30 > cacti[i].x && dino.y + 40 > cacti[i].y) {
                    showEndScreen();
                }
                if (cacti[i].x < -50) cacti.splice(i, 1);
            }

            document.getElementById('total-coins-display').innerText = "Монеты: " + (coinsBeforeRun + sessionMoney);
            document.getElementById('score-info').innerText = "Дистанция: " + Math.floor(distance) + " м";
            
            requestAnimationFrame(loop);
        }

        window.addEventListener("keydown", e => {
            if (e.code === "Space" && dino.ground && isPlaying && !isPaused) {
                dino.dy = dino.jump;
                dino.ground = false;
                playSnd(sndJump);
            }
            if (e.code === "Escape") togglePause();
        });

        loop();
    </script>
</body>
</html>
