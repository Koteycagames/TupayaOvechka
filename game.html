<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Farm Run - –ò–≥—Ä–∞</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #game-ui, #pause-ui, #ad-menu, #ad-video-overlay, #settings-ui { 
            position: absolute; inset: 0; 
            background: rgba(255,255,255,0.98); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            z-index: 100; font-family: sans-serif;
        }
        .hidden { display: none !important; }
        #hud { 
            position: absolute; top: 10px; left: 20px; 
            text-align: left; pointer-events: none; z-index: 10; 
            font-family: sans-serif;
        }
        canvas { display: block; background: #fff; border-bottom: 2px solid #000; }
        
        #add-coins-btn {
            pointer-events: auto; background: #4CAF50; color: white;
            border: none; border-radius: 5px; padding: 2px 12px;
            cursor: pointer; font-weight: bold; font-size: 20px; margin-left: 10px;
        }

        .ad-option {
            background: #f9f9f9; border: 2px solid #ddd; padding: 15px;
            margin: 8px; width: 340px; display: flex;
            justify-content: space-between; align-items: center;
            cursor: pointer; border-radius: 10px; font-size: 18px;
        }
        .ad-option:hover { background: #eee; }

        #ad-video-overlay { background: #000; z-index: 1000; }
        #ad-timer-display { 
            position: absolute; top: 20px; left: 20px; 
            color: white; font-size: 20px; background: rgba(0,0,0,0.6);
            padding: 5px 15px; border-radius: 20px;
        }
        #close-ad-btn {
            position: absolute; top: 20px; right: 20px;
            width: 45px; height: 45px; background: white;
            color: black; border: none; border-radius: 50%;
            font-size: 28px; font-weight: bold; cursor: pointer;
            display: flex; align-items: center; justify-content: center;
        }
        #video-wrapper { 
            width: 85%; max-width: 900px; aspect-ratio: 16/9; 
            background: #111; border: 2px solid #333;
        }
        .menu-btn { margin: 10px; padding: 12px 30px; cursor: pointer; font-weight: bold; min-width: 200px; border-radius: 5px; border: 1px solid #ccc; }
        .toggle-row { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; font-size: 20px; }
    </style>
</head>
<body>

    <div id="hud">
        <div id="score-info" style="font-weight: bold; font-size: 16px;">–î–∏—Å—Ç–∞–Ω—Ü–∏—è: 0 –º</div>
        <div style="display: flex; align-items: center;">
            <div id="total-coins-display" style="color: #B8860B; font-weight: bold; font-size: 20px;">–ú–æ–Ω–µ—Ç—ã: 0</div>
            <button id="add-coins-btn" onclick="openAdMenu()">+</button>
        </div>
    </div>

    <button id="pause-btn" style="position:absolute; top:10px; right:20px; z-index:20; cursor:pointer;" onclick="togglePause()">–ü–ê–£–ó–ê (Esc)</button>

    <canvas id="gameCanvas"></canvas>

    <div id="settings-ui" class="hidden">
        <h1>–ù–ê–°–¢–†–û–ô–ö–ò</h1>
        <div class="toggle-row">
            <label>–ó–≤—É–∫–∏ –≤ –∏–≥—Ä–µ:</label>
            <input type="checkbox" id="sound-check" style="width:25px; height:25px;">
        </div>
        <button class="menu-btn" onclick="closeSettings()">–°–û–•–†–ê–ù–ò–¢–¨ –ò –ù–ê–ó–ê–î</button>
    </div>

    <div id="ad-menu" class="hidden">
        <h2 style="margin-bottom:20px;">–ë–µ—Å–ø–ª–∞—Ç–Ω—ã–µ –º–æ–Ω–µ—Ç—ã</h2>
        <div class="ad-option" onclick="startAd(15, 15, '93R2rAgj4pA')"><span>15 —Å–µ–∫</span> <b>+15 üí∞</b></div>
        <div class="ad-option" onclick="startAd(30, 25, '6M1xLM9OO28')"><span>30 —Å–µ–∫</span> <b>+25 üí∞</b></div>
        <div class="ad-option" onclick="startAd(60, 40, 'QXbn6GPdOhw')"><span>60 —Å–µ–∫</span> <b>+40 üí∞</b></div>
        <div class="ad-option" onclick="startAd(120, 80, 'F9zGow9FExc')"><span>120 —Å–µ–∫</span> <b>+80 üí∞</b></div>
        <div class="ad-option" onclick="startAd(180, 120, 'B6cVgEEvFkY')"><span>180 —Å–µ–∫</span> <b>+120 üí∞</b></div>
        <button class="menu-btn" onclick="closeAdMenu()" style="margin-top:20px;">–ó–ê–ö–†–´–¢–¨</button>
    </div>

    <div id="ad-video-overlay" class="hidden">
        <div id="ad-timer-display">–†–µ–∫–ª–∞–º–∞: <span id="time-num">--</span> —Å–µ–∫</div>
        <button id="close-ad-btn" class="hidden" onclick="finishAd()">‚úï</button>
        <div id="video-wrapper"></div>
    </div>

    <div id="pause-ui" class="hidden">
        <h1>–ü–ê–£–ó–ê</h1>
        <button class="menu-btn" onclick="togglePause()">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
        <button class="menu-btn" onclick="openSettings()">–ù–ê–°–¢–†–û–ô–ö–ò</button>
        <button class="menu-btn" onclick="location.href='main.html'">–í –ú–ï–ù–Æ (–°–±—Ä–æ—Å)</button>
    </div>
    
    <div id="game-ui" class="hidden">
        <h1>–†–ï–ó–£–õ–¨–¢–ê–¢–´</h1>
        <div id="res-stats" style="margin-bottom: 20px; text-align: left; min-width: 200px; font-size: 18px;"></div>
        <button class="menu-btn" onclick="resetGame()">–ï–©–ï –†–ê–ó</button>
        <button class="menu-btn" onclick="location.href='main.html'">–í –ú–ï–ù–Æ</button>
    </div>

    <script>
        let adReward = 0, adTimeLeft = 0, adInterval;
        let soundEnabled = localStorage.getItem('dinoSound') !== 'false';

        // –õ–û–ì–ò–ö–ê –ù–ê–°–¢–†–û–ï–ö
        function openSettings() {
            document.getElementById('pause-ui').classList.add('hidden');
            document.getElementById('settings-ui').classList.remove('hidden');
            document.getElementById('sound-check').checked = soundEnabled;
        }
        function closeSettings() {
            soundEnabled = document.getElementById('sound-check').checked;
            localStorage.setItem('dinoSound', soundEnabled);
            document.getElementById('settings-ui').classList.add('hidden');
            document.getElementById('pause-ui').classList.remove('hidden');
        }

        // –õ–û–ì–ò–ö–ê –†–ï–ö–õ–ê–ú–´ (IFRAME FIX)
        function openAdMenu() { isPaused = true; document.getElementById('ad-menu').classList.remove('hidden'); }
        function closeAdMenu() { document.getElementById('ad-menu').classList.add('hidden'); isPaused = false; if(isPlaying) requestAnimationFrame(loop); }

        function startAd(seconds, reward, videoId) {
            adReward = reward;
            adTimeLeft = seconds;
            document.getElementById('ad-menu').classList.add('hidden');
            document.getElementById('ad-video-overlay').classList.remove('hidden');
            document.getElementById('close-ad-btn').classList.add('hidden');
            document.getElementById('time-num').innerText = adTimeLeft;

            const wrapper = document.getElementById('video-wrapper');
            wrapper.innerHTML = `<iframe width="100%" height="100%" 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&controls=1&rel=0" 
                frameborder="0" allow="autoplay; encrypted-media" allowfullscreen></iframe>`;

            if (adInterval) clearInterval(adInterval);
            adInterval = setInterval(() => {
                adTimeLeft--;
                if (adTimeLeft >= 0) document.getElementById('time-num').innerText = adTimeLeft;
                if (adTimeLeft <= 0) {
                    clearInterval(adInterval);
                    document.getElementById('ad-timer-display').innerText = "–ì–æ—Ç–æ–≤–æ!";
                    document.getElementById('close-ad-btn').classList.remove('hidden');
                }
            }, 1000);
        }

        function finishAd() {
            document.getElementById('video-wrapper').innerHTML = "";
            let currentCoins = parseInt(localStorage.getItem('dinoCoins')) || 0;
            localStorage.setItem('dinoCoins', currentCoins + adReward);
            coinsBeforeRun = currentCoins + adReward;
            document.getElementById('total-coins-display').innerText = "–ú–æ–Ω–µ—Ç—ã: " + (coinsBeforeRun + sessionMoney);
            document.getElementById('ad-video-overlay').classList.add('hidden');
            closeAdMenu();
        }

        // --- –ò–ì–†–û–í–û–ô –î–í–ò–ñ–û–ö ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 800; canvas.height = 250;

        const activeSkin = localStorage.getItem('activeSkin') || 'baran';
        const sndJump = new Audio('sounds/jump.mp3');
        const sndCoin = new Audio('sounds/coin.mp3');
        const sndHit = new Audio('sounds/hit.mp3');
        sndJump.volume = 0.2; sndCoin.volume = 0.2; sndHit.volume = 0.2;

        let isPlaying = true, isPaused = false;
        let distance = 0, sessionMoney = 0;
        let coinsBeforeRun = parseInt(localStorage.getItem('dinoCoins')) || 0;
        let gameSpeed = 5, lastCactusX = 0, nextCactusDistance = 500;
        let cacti = [], coins = [], dino = { x: 50, y: 200, w: 50, h: 50, dy: 0, jump: -13, grav: 0.7, ground: true };

        const imgPlayer = new Image(); imgPlayer.src = `images/${activeSkin}.png`;
        const imgCactus = new Image(); imgCactus.src = `images/cactus.png`;

        function playSnd(audio) { if(soundEnabled) { audio.currentTime = 0; audio.play().catch(()=>{}); } }

        function togglePause() {
            if (!isPlaying) return;
            isPaused = !isPaused;
            document.getElementById('pause-ui').classList.toggle('hidden', !isPaused);
            if (!isPaused) requestAnimationFrame(loop);
        }

        function resetGame() {
            coinsBeforeRun = parseInt(localStorage.getItem('dinoCoins')) || 0;
            isPlaying = true; isPaused = false; distance = 0; sessionMoney = 0; gameSpeed = 5;
            lastCactusX = 0; nextCactusDistance = 500; cacti = []; coins = [];
            dino.y = 200; dino.dy = 0; dino.ground = true;
            document.getElementById('game-ui').classList.add('hidden');
            requestAnimationFrame(loop);
        }

        function showEndScreen() {
            isPlaying = false; playSnd(sndHit);
            const finalWallet = coinsBeforeRun + sessionMoney;
            localStorage.setItem('dinoCoins', finalWallet);
            let record = parseInt(localStorage.getItem('dinoRecord')) || 0;
            if (Math.floor(distance) > record) { record = Math.floor(distance); localStorage.setItem('dinoRecord', record); }
            document.getElementById('res-stats').innerHTML = `–î–∏—Å—Ç–∞–Ω—Ü–∏—è: ${Math.floor(distance)} –º<br>–†–µ–∫–æ—Ä–¥: ${record} –º<br>–°–æ–±—Ä–∞–Ω–æ: +${sessionMoney}<br>–ò—Ç–æ–≥–æ: ${finalWallet} üí∞`;
            document.getElementById('game-ui').classList.remove('hidden');
        }

        function loop() {
            if (!isPlaying || isPaused) return;
            ctx.clearRect(0,0, canvas.width, canvas.height);
            gameSpeed += 0.0006; distance += gameSpeed / 130;

            if (canvas.width - lastCactusX > nextCactusDistance) {
                cacti.push({x: canvas.width, y: 200, w: 40, h: 50});
                lastCactusX = canvas.width;
                nextCactusDistance = 350 + (Math.random() * 550) + (gameSpeed * 5);
            }

            dino.dy += dino.grav; dino.y += dino.dy;
            if (dino.y > 200) { dino.y = 200; dino.dy = 0; dino.ground = true; }
            ctx.drawImage(imgPlayer, dino.x, dino.y, 50, 50);

            for (let i = cacti.length-1; i>=0; i--) {
                cacti[i].x -= gameSpeed;
                ctx.drawImage(imgCactus, cacti[i].x, cacti[i].y, 40, 50);
                if (dino.x < cacti[i].x + 30 && dino.x + 35 > cacti[i].x && dino.y + 40 > cacti[i].y) showEndScreen();
                if (cacti[i].x < -50) cacti.splice(i,1);
            }
            
            for (let i = coins.length-1; i>=0; i--) {
                coins[i].x -= gameSpeed;
                ctx.fillStyle = "gold"; ctx.beginPath(); ctx.arc(coins[i].x, coins[i].y, 10, 0, Math.PI*2); ctx.fill();
                if (Math.hypot(coins[i].x-(dino.x+25), coins[i].y-(dino.y+25)) < 35) { sessionMoney++; playSnd(sndCoin); coins.splice(i,1); }
            }
            if (Math.random() < 0.015) coins.push({x: canvas.width, y: 110+Math.random()*80});

            lastCactusX -= gameSpeed;
            document.getElementById('total-coins-display').innerText = "–ú–æ–Ω–µ—Ç—ã: " + (coinsBeforeRun + sessionMoney);
            document.getElementById('score-info').innerText = "–î–∏—Å—Ç–∞–Ω—Ü–∏—è: " + Math.floor(distance) + " –º";
            requestAnimationFrame(loop);
        }

        window.addEventListener("keydown", e => { 
            if(e.code==="Space") { e.preventDefault(); isPlaying ? (dino.ground && (dino.dy=dino.jump, dino.ground=false, playSnd(sndJump))) : resetGame(); }
            if(e.code==="Escape") togglePause();
        });
        canvas.addEventListener("mousedown", () => { isPlaying ? (dino.ground && (dino.dy=dino.jump, dino.ground=false, playSnd(sndJump))) : resetGame(); });
        imgPlayer.onload = () => { document.getElementById('total-coins-display').innerText = "–ú–æ–Ω–µ—Ç—ã: " + coinsBeforeRun; loop(); };
    </script>
</body>
</html>