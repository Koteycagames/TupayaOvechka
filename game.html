<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Farm Run - Игра</title>
    <style>
        /* ВОЗВРАЩАЕМ СТАРЫЙ ДИЗАЙН */
        body { margin: 0; background: #222; color: white; font-family: sans-serif; overflow: hidden; }
        canvas { display: block; background: #fff; border-bottom: 5px solid #000; margin: 0 auto; }
        
        #hud { position: absolute; top: 10px; left: 20px; z-index: 10; pointer-events: none; }
        #score-info { font-weight: bold; font-size: 18px; color: #fff; text-shadow: 1px 1px 2px #000; }
        #total-coins-display { color: #FFD700; font-weight: bold; font-size: 22px; text-shadow: 1px 1px 2px #000; }

        .ui-layer { 
            position: absolute; inset: 0; 
            background: rgba(0,0,0,0.85); 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center; 
            z-index: 100; 
        }
        .hidden { display: none !important; }

        .menu-btn { 
            margin: 10px; padding: 15px 30px; 
            font-size: 18px; font-weight: bold; 
            cursor: pointer; background: #4CAF50; 
            color: white; border: 2px solid #fff; 
            border-radius: 10px; min-width: 220px; 
        }
        .menu-btn:hover { background: #45a049; }
        
        #pause-btn {
            position: absolute; top: 10px; right: 20px; z-index: 20;
            background: #444; color: white; border: 1px solid #fff;
            padding: 8px 15px; cursor: pointer; border-radius: 5px;
        }
    </style>
</head>
<body>

    <div id="hud">
        <div id="score-info">Дистанция: 0 м</div>
        <div id="total-coins-display">Монеты: 0</div>
    </div>

    <button id="pause-btn" onclick="togglePause()">ПАУЗА (Esc)</button>

    <canvas id="gameCanvas"></canvas>

    <div id="pause-ui" class="ui-layer hidden">
        <h1 style="color: #4CAF50;">ПАУЗА</h1>
        <button class="menu-btn" onclick="togglePause()">ПРОДОЛЖИТЬ</button>
        <button class="menu-btn" onclick="openSettings()">НАСТРОЙКИ</button>
        <button class="menu-btn" style="background:#f44336;" onclick="location.href='index.html'">В МЕНЮ</button>
    </div>

    <div id="settings-ui" class="ui-layer hidden">
        <h1>НАСТРОЙКИ</h1>
        <label style="font-size:22px; margin-bottom:30px;">
            <input type="checkbox" id="sound-check" style="transform:scale(1.8);"> Звук
        </label>
        <button class="menu-btn" onclick="closeSettings()">СОХРАНИТЬ И НАЗАД</button>
    </div>

    <div id="game-ui" class="ui-layer hidden">
        <h1 style="color: #f44336;">GAME OVER</h1>
        <div id="res-stats" style="font-size: 24px; margin-bottom: 25px;"></div>
        <button class="menu-btn" onclick="resetGame()">ПОПРОБОВАТЬ СНОВА</button>
        <button class="menu-btn" style="background:#555;" onclick="location.href='index.html'">В МЕНЮ</button>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        canvas.width = 800; canvas.height = 250;

        let soundEnabled = localStorage.getItem('dinoSound') !== 'false';
        const activeSkin = localStorage.getItem('activeSkin') || 'baran';

        // ПУТИ С ФИКСОМ ДЛЯ GITHUB
        const sndJump = new Audio('sounds/jump.mp3');
        const sndHit = new Audio('sounds/hit.mp3');
        const imgPlayer = new Image();
        const imgCactus = new Image();

        // Попытка загрузить картинки
        imgPlayer.src = "images/" + activeSkin + ".png";
        imgCactus.src = "images/cactus.png";

        let imagesLoaded = 0;
        let loadError = false;

        imgPlayer.onload = () => imagesLoaded++;
        imgCactus.onload = () => imagesLoaded++;
        
        imgPlayer.onerror = imgCactus.onerror = (e) => {
            console.error("Ошибка загрузки картинки:", e.target.src);
            loadError = true;
        };

        let isPlaying = true, isPaused = false;
        let distance = 0, sessionMoney = 0;
        let coinsBeforeRun = parseInt(localStorage.getItem('dinoCoins')) || 0;
        let gameSpeed = 5;
        let cacti = [];
        let dino = { x: 50, y: 200, dy: 0, jump: -13, grav: 0.7, ground: true };

        function playSnd(audio) {
            if(soundEnabled) { audio.currentTime = 0; audio.play().catch(() => {}); }
        }

        function togglePause() {
            if (!isPlaying) return;
            isPaused = !isPaused;
            document.getElementById('pause-ui').classList.toggle('hidden', !isPaused);
            if (!isPaused) requestAnimationFrame(loop);
        }

        function openSettings() {
            document.getElementById('pause-ui').classList.add('hidden');
            document.getElementById('settings-ui').classList.remove('hidden');
            document.getElementById('sound-check').checked = soundEnabled;
        }

        function closeSettings() {
            soundEnabled = document.getElementById('sound-check').checked;
            localStorage.setItem('dinoSound', soundEnabled);
            document.getElementById('settings-ui').classList.add('hidden');
            document.getElementById('pause-ui').classList.remove('hidden');
        }

        function showEndScreen() {
            isPlaying = false;
            playSnd(sndHit);
            const total = coinsBeforeRun + sessionMoney;
            localStorage.setItem('dinoCoins', total);
            document.getElementById('res-stats').innerHTML = `Расстояние: ${Math.floor(distance)}м<br>Монеты: +${sessionMoney}`;
            document.getElementById('game-ui').classList.remove('hidden');
        }

        function resetGame() { location.reload(); }

        function loop() {
            if (!isPlaying || isPaused) return;

            // Если картинки не загрузились, рисуем просто квадраты, чтобы игра не вылетала
            ctx.clearRect(0,0, canvas.width, canvas.height);
            gameSpeed += 0.001;
            distance += gameSpeed / 100;

            dino.dy += dino.grav;
            dino.y += dino.dy;
            if (dino.y > 200) { dino.y = 200; dino.dy = 0; dino.ground = true; }

            // Рисуем игрока
            if (imagesLoaded >= 2) {
                ctx.drawImage(imgPlayer, dino.x, dino.y, 50, 50);
            } else {
                ctx.fillStyle = "blue"; ctx.fillRect(dino.x, dino.y, 50, 50);
            }

            if (Math.random() < 0.01 && (cacti.length === 0 || cacti[cacti.length-1].x < 500)) {
                cacti.push({x: 800, y: 200});
            }

            for (let i = cacti.length-1; i>=0; i--) {
                cacti[i].x -= gameSpeed;
                
                if (imagesLoaded >= 2) {
                    ctx.drawImage(imgCactus, cacti[i].x, cacti[i].y, 40, 50);
                } else {
                    ctx.fillStyle = "red"; ctx.fillRect(cacti[i].x, cacti[i].y, 40, 50);
                }

                if (dino.x < cacti[i].x + 30 && dino.x + 30 > cacti[i].x && dino.y + 40 > cacti[i].y) {
                    showEndScreen();
                }
                if (cacti[i].x < -50) cacti.splice(i, 1);
            }

            document.getElementById('total-coins-display').innerText = "Монеты: " + (coinsBeforeRun + sessionMoney);
            document.getElementById('score-info').innerText = "Дистанция: " + Math.floor(distance) + " м";
            
            requestAnimationFrame(loop);
        }

        window.addEventListener("keydown", e => {
            if ((e.code === "Space" || e.key === " ") && dino.ground && isPlaying && !isPaused) {
                e.preventDefault();
                dino.dy = dino.jump;
                dino.ground = false;
                playSnd(sndJump);
            }
            if (e.code === "Escape") togglePause();
        });

        loop();
    </script>
</body>
</html>
